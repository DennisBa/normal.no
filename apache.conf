# To install on a Debian system:
# 1) Symlink this into: /etc/apache2/sites-available/
# 2) Then do a: a2ensite <symlink-name>
# Note: The code must be checked out into /srv/www/normal.no

# These Apache modules are required (and not enabled by default):
# mod_wsgi, mod_expires
# These Apache module are required (but are enabled by default).
# mod_alias, mod_setenvif

# @todo mod_gnutls
# @todo mod_rewrite

# Run syntax check for config files:
# $ apachectl -t


# Normalize URLs: www.normal.no => normal.no
# Note: normal.no/foo => normal.no/foo/ is done by Django (APPEND_SLASH)
<VirtualHost *:80>
    ServerName www.normal.no
    Redirect permanent /    http://normal.no/
</VirtualHost>


<VirtualHost *:80>
    Include /srv/www/normal.no/apache.conf.common

    # Force encryption on enrollment form and /admin/*
    # Note: See TLS-section, there encryption is "unenforced"
    RedirectMatch 301 ^/bli-medlem/$	https://normal.no/bli-medlem/
    RedirectMatch 301 ^/admin/(.*)	https://normal.no/admin/$1
</VirtualHost>


<IfModule mod_gnutls.c>
<VirtualHost *:443>
    GnuTLSEnable	    On
    GnuTLSPriorities	    NORMAL
    GnuTLSKeyFile           /srv/www/certs/normal.no.key
    GnuTLSCertificateFile   /srv/www/certs/normal.no.crt

    # @todo disable sslv3

    Include /srv/www/normal.no/apache.conf.common
</VirtualHost>
</IfModule>


<IfModule mod_ssl.c>
<VirtualHost *:443>
    Include /srv/www/normal.no/apache.conf.common

    # "Unforce" encryption
    # @todo howto share between both ssl sections?
    # Update: Did not work. Will get mixed ssl and non-ssl content.
    # Fix: blacklist all resources (css,js,images)
    # Better fix? Only disable encryption for some urls (whitelist)
#    RewriteEngine on
#    RewriteCond %{REQUEST_URI} !^/admin/
#    RewriteCond %{REQUEST_URI} !^/bli-medlem/
#    RewriteRule (.*) http://normal.no/$1 [R=301,L]

    SSLEngine on
    SSLCertificateFile	    /srv/www/certs/normal.no.crt
    SSLCertificateKeyFile   /srv/www/certs/normal.no.key
    # OpenSSL don't support multiple certs in SSLCertificateFile
    SSLCertificateChainFile /srv/www/certs/normal.no.crt
    # Disabling SSLv3 to avoid the POODLE attack
    # https://www.linode.com/docs/security/security-patches/disabling-sslv3-for-poodle
    SSLProtocol All -SSLv2 -SSLv3
</VirtualHost>
</IfModule>
